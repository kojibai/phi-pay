# KRL-1.0 — Krystal Resource Locators

A **KRL** is a string that locates either:

- a **Moment** (a self-contained JSON envelope), or
- an **Artifact** (content-addressed bytes, identified by a 32-byte hash).

KRL-1.0 defines two locator families commonly transported as `http(s)` URLs:

1. **Stream Locators** — embed a JSON moment in base64url form (either in the path or in a fragment parameter).
2. **Content Locators** — address bytes by hash and MAY carry an attached metadata payload.

This spec defines decoding rules so a verifier can extract `pulse` and validate KKS coordinates.

---

## Base64url encoding (un-padded)

KRL-1.0 uses **base64url without padding**:

- Alphabet: `A-Z a-z 0-9 - _`
- No trailing `=` padding characters.

To decode, a verifier MUST restore padding as needed before base64 decoding.

---

## 1) Stream Locators

Stream locators have two equivalent shapes.

### 1A) Path form

```
{scheme}://{host}/stream/p/{B64URL_JSON}
```

### 1B) Fragment form

```
{scheme}://{host}/stream#t={B64URL_JSON}
```

Where:

- `{B64URL_JSON}` is base64url(unpadded) of UTF-8 JSON bytes.
- The decoded JSON MUST be an object and MUST contain:
  - `pulse` (integer)

Common optional fields include `caption`, `body`, `phiKey`, `kaiSignature`, `ts`, etc.

### Decoding requirements

A conforming decoder MUST:

1. Extract `{B64URL_JSON}` from either:
   - the path segment after `/stream/p/`, or
   - the fragment query parameter `t` in `/stream#t=...`
2. base64url-decode it to bytes.
3. Interpret the bytes as UTF-8 JSON and parse to an object.

If the decoded object includes `beat` and/or `stepIndex`, they MUST match the derived KKS coordinate for its `pulse`.

---

## 2) Content Locators (artifact hash + optional metadata)

Shape:

```
{scheme}://{host}/s/{HEX_SHA256}[?p={P_PAYLOAD}]
```

Where:

- `{HEX_SHA256}` is 64 lowercase hex chars identifying the artifact bytes (SHA-256 digest).
- Query parameter `p` is OPTIONAL and MAY be one of:
  - **Expanded payload:** `p = {B64URL_JSON}`
  - **Capsule payload:**  `p = c:{B64URL_JSON}`

### Expanded payload (recommended for clarity)

The decoded JSON commonly contains:

- `pulse` (integer)
- `beat` (0..35)
- `stepIndex` (0..43)
- `stepsPerBeat` (44 for KKS-1.0)

A verifier MUST recompute `beat` and `stepIndex` from `pulse` and MUST reject mismatches.

### Capsule payload (compact)

The decoded JSON commonly contains compact keys:

- `u` (pulse)
- `b` (beat)
- `s` (stepIndex)
- `d` (stepsPerBeat)

A verifier MUST treat `u` as `pulse`, `b` as `beat`, and `s` as `stepIndex` and validate them with KKS.

---

## Notes on artifact bytes

KRL-1.0 defines how to decode locators. It does NOT require a specific transport for artifact bytes.

If artifact bytes are available, a verifier SHOULD compute SHA-256(bytes) and confirm it equals `{HEX_SHA256}`.

